name: Pure Python Pipeline

on:
    push:
        branches: ["main"]
    workflow_dispatch:

jobs:
    # 任务 1: 测试 (完全零依赖，速度极快)
    test:
        runs-on: ubuntu-latest
        # 直接使用 Python 官方镜像，避开 checkout Action 的 Node 依赖问题
        container:
            image: nikolaik/python-nodejs

        steps:
            # 1. 拉取代码 (使用 git 命令，甚至不需要 actions/checkout)
            # 但为了方便，我们还是用 checkout@v4 (假设你已经镜像了它)
            # 如果没有镜像，可以直接用 Gitea 内置的 clone 逻辑
            - name: Checkout
              uses: actions/checkout@v4

            # 2. 运行测试 (使用标准库，无需 pip install)
            - name: Run Unittest
              run: python test_main.py

    # 任务 2: 构建并推送 (复用之前的优雅配置)
    build:
        needs: test
        runs-on: ubuntu-latest
        permissions:
            packages: write
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            # 使用 Docker Meta 生成标签 (优雅的小写转换)
            - name: Docker Meta
              id: meta
              uses: docker/metadata-action@v5
              with:
                  # 引用变量 vars.DOCKER_REGISTRY (记得在 Gitea 设置)
                  images: ${{ vars.DOCKER_REGISTRY }}/${{ github.repository }}
                  tags: type=raw,value=latest

            # 登录 Registry
            - name: Login
              uses: docker/login-action@v3
              with:
                  registry: ${{ vars.DOCKER_REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            # 构建并推送
            - name: Build and Push
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
